{% extends "base.html" %}

{% block title %}LEAM - Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h2 class="text-center mb-4">Optimization Results</h2>
        
        {% if error %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error!</h4>
            <p>{{ error }}</p>
            {% if error_detail %}
            <hr>
            <details>
                <summary>Technical Details (for debugging)</summary>
                <pre class="mt-2">{{ error_detail }}</pre>
            </details>
            {% endif %}
        </div>
        {% else %}
        
        <!-- Model Information -->
        <div class="results-section" style="background-color: rgb(210, 210, 210);">
            <h4 class="text-primary mb-3">Model Information</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Model Type:</strong> {{ model_info.type }}</p>
                    <p><strong>Status:</strong> <span class="badge bg-success">{{ model_info.status }}</span></p>
                </div>
                <div class="col-md-6">
                    {% if model_info.type == "Target-Based" %}
                    <p><strong>Total Cost:</strong> ${{ "%.2f"|format(model_info.objective) }} {{ model_info.objective_units }}</p>
                    {% else %}
                    <p><strong>Objective Value:</strong> {{ "%.4f"|format(model_info.objective) }} {{ model_info.objective_units }}</p>
                    <p><strong>Total Cost:</strong> ${{ "%.2f"|format(model_info.total_cost) }} million CAD</p>
                    {% endif %}
                    <p><strong>Solve Time:</strong> {{ model_info.solve_time }} seconds</p>
                </div>
            </div>
        </div>

        <!-- Abatement -->
        <div class="row">
            <div class="col-md-5">
                <!-- Agriculture -->
                <div class="results-section">
                    <h4 class="text-primary mb-3">Agriculture</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Region</th>
                                    <th>Abatement<br>(tonnes/year)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for region, value in results.agricultural_abatement.items() %}
                                <tr>
                                    <td><strong>{{ region }}</strong></td>
                                    <td>{{ "%.2f"|format(value) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- WWTP Results-->
            <div class="col-md-7">
            <div class="results-section">
                    <h4 class="text-primary mb-3">Wastewater Treatment Plants</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Region</th>
                                    <th>WWTPs<br>upgraded</th>
                                    <th>Abatement<br>(tonnes/year)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for region, plants in results.wwtp_upgrades.items() %}
                                <tr>
                                    <td><strong>{{ region }}</strong></td>
                                    <td>{{ plants }}</td>
                                    <td>{{ results.wwtp_abatement[region] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phosphorus Changes -->
        <div class="results-section col-lg-8">
            <h4 class="text-primary mb-3">Phosphorus Change</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Region</th>
                            <th>Concentration Reduction (ppb)</th>
                            <th>TP removed from water body (tonnes)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for region in results.concentration_change.keys() %}
                        <tr>
                            <td><strong>{{ region }}</strong></td>
                            <td>{{ "%.4f"|format(results.concentration_change[region]) }}</td>
                            <td>{{ "%.4f"|format(results.steadystate_mass_change[region]) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- WWTP Results -->
        <div class="results-section">
            <div class="row">
            <div class="col-md-6 position-relative">
                <h4 class="text-primary mb-3">Load Reduction</h4>
                <canvas id="abatementChart" height="230"></canvas>
            </div> 
            <div class="col-md-6 position-relative">
                <h4 class="text-primary mb-3">Response Reduction</h4>
                <canvas id="responseChart" height="230"></canvas>
            </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="results-section">
            <h4 class="text-primary mb-3">Summary</h4>
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Agricultural Abatement</h5>
                            <p class="card-text display-6">{{ "%.1f"|format(results.total_agro_abatement) }}</p>
                            <small class="text-muted">tonnes P/year</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">WWTP Abatement</h5>
                            <p class="card-text display-6">{{ "%.1f"|format(results.total_wwtp_abatement) }}</p>
                            <small class="text-muted">tonnes P/year</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">WWTPs Upgraded</h5>
                            <p class="card-text display-6">{{ results.total_wwtps }}</p>
                            <small class="text-muted">facilities</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">TP Removed From Water Bodies</h5>
                            <p class="card-text display-6">{{ "%.1f"|format(results.total_steadystate_mass_change) }}</p>
                            <small class="text-muted">tonnes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

        <div class="text-center mt-4">
            {% if not error %}
            <button id="downloadJson" class="btn btn-success btn-lg me-3 mb-3">
                <i class="bi bi-download"></i> Download (ZIP)
            </button>
            {% endif %}
            <a href="/optimize" class="btn btn-primary btn-lg mb-3">
                <i class="bi bi-arrow-repeat"></i> Another Run
            </a>
            <a href="/" class="btn btn-secondary btn-lg ms-3 mb-3">
                <i class="bi bi-house"></i> Home
            </a>
        </div>
    </div>
</div>

{% if not error %}
<script src="/static/js/jszip.min.js"></script>
<script src="/static/js/FileSaver.min.js"></script>
<script>
document.getElementById('downloadJson').addEventListener('click', function() {
    const data = {
        model_info: {{ model_info | tojson }},
        results: {{ results | tojson }}
    };
    
    // Create timestamp
    const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
    const modelType = 'leam_' + data.model_info.type[0] + data.model_info.type[data.model_info.type.indexOf('-') + 1] + 'm';
    
    // Create metadata.txt content
    const metadata = `Lake Erie Abatement Model (LEAM) - Results
================================================
Model Type: ${data.model_info.type}
Status: ${data.model_info.status}
${data.model_info.type === "Target-Based" ? 
    `Total Cost: $${data.model_info.objective.toFixed(2)} ${data.model_info.objective_units}` :
    `Objective Value: ${data.model_info.objective.toFixed(4)} ${data.model_info.objective_units}
Total Cost: $${data.model_info.total_cost.toFixed(2)} million CAD`}
Solve Time: ${data.model_info.solve_time} seconds
Timestamp: ${new Date().toISOString()}

Summary
================================================
Total Agricultural Abatement: ${data.results.total_agro_abatement.toFixed(1)} tonnes P/year
Total WWTP Abatement: ${data.results.total_wwtp_abatement.toFixed(1)} tonnes P/year
Total WWTPs Upgraded: ${data.results.total_wwtps} facilities
Total TP Removed From Water Bodies: ${data.results.total_steadystate_mass_change.toFixed(1)} tonnes

Column Units for solution.csv
================================================
agriculture_P_abate: tonnes P/year
wwtp_P_abate: tonnes P/year
n_wwtp: number of facilities upgraded (unitless)
concentration_decrease: ppb
P_mass_change: tonnes of P removed from water body
`;
    // Create solution.csv content
    const regions = ['SCR', 'LSC', 'DR', 'WB', 'CB', 'EB'];
    let csvContent = 'region,agriculture_P_abate,wwtp_P_abate,n_wwtp,concentration_decrease,P_mass_change\n';
    
    regions.forEach(region => {
        csvContent += `${region},`;
        csvContent += `${data.results.agricultural_abatement[region].toFixed(2)},`;
        csvContent += `${data.results.wwtp_abatement[region].toFixed(2)},`;
        csvContent += `${data.results.wwtp_upgrades[region]},`;
        csvContent += `${data.results.concentration_change[region].toFixed(4)},`;
        csvContent += `${data.results.steadystate_mass_change[region].toFixed(4)}\n`;
    });
    
    // Create ZIP file
    const zip = new JSZip();
    zip.file('metadata.txt', metadata);
    zip.file('solution.csv', csvContent);
    
    // Generate and download ZIP
    zip.generateAsync({type: 'blob'}).then(function(content) {
        saveAs(content, `${modelType.toLowerCase()}_${timestamp}.zip`);
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Input Change Chart
    const regions = ['SCR', 'LSC', 'DR', 'WB', 'CB', 'EB'];
    const agroData = {{ results.agricultural_abatement | tojson }};
    const wwtpData = {{ results.wwtp_abatement | tojson }};

    const ctx = document.getElementById('abatementChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: regions,
            datasets: [{
                label: 'Agriculture',
                data: regions.map(region => agroData[region].toFixed(2)),
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(54, 54, 54, 1)',
                borderWidth: 1
            },
            {
                label: 'WWTPs',
                data: regions.map(region => wwtpData[region].toFixed(2)),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 54, 54, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true
                },
                title: {
                    display: true,
                    text: 'Abatement (tonne/year)'
                }
            },
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
    // Response Chart
    const loadChanges = {{ results.steadystate_mass_change | tojson }};
    const ctx2 = document.getElementById('responseChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: regions,
            datasets: [{
                label: 'P Removed from Water Body',
                data: regions.map(region => loadChanges[region].toFixed(4)),
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(54, 54, 54, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'P Removed from Water Bodies (tonnes)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

{% endif %}
{% endblock %}
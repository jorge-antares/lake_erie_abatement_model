{% extends "base.html" %}

{% block title %}Optimization Parameters{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h2 class="text-center mb-4">Model Parameters</h2>

        <!-- Mathematical Model Description -->
        <div class="alert alert-info mb-4">
            <h5><i class="bi bi-info-circle"></i> Mathematical Model</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>Target-Based Model:</h6>
                    <p>
                        $$\min \mathbf{x}^T \mathbf{A} \mathbf{x} + \mathbf{b}^T \mathbf{w}$$
                        subject to:
                        $$\mathbf{S} \mathbf{x} + \mathbf{W} \mathbf{w} \geq \mathbf{z}_{target}$$
                        $$\mathbf{x} \geq 0, \quad \mathbf{w} \in \{0,1\}$$
                    </p>
                </div>
                <div class="col-md-6">
                    <h6>Budget-Based Model:</h6>
                    <p>
                        $$\max \mathbf{c}^T (\mathbf{S} \mathbf{x} + \mathbf{W} \mathbf{w})$$
                        subject to:
                        $$\mathbf{x}^T \mathbf{A} \mathbf{x} + \mathbf{b}^T \mathbf{w} \leq B$$
                        $$\mathbf{x} \geq 0, \quad \mathbf{w} \in \{0,1\}$$
                    </p>
                </div>
            </div>
            <div class="mt-3">
                <h6>Where:</h6>
                <ul class="list-unstyled">
                    <li>$\mathbf{x}$ = Agricultural abatement by region (tonnes/year)</li>
                    <li>$\mathbf{w}$ = Binary variables for WWTP investments</li>
                    <li>$\mathbf{A}$ = Agricultural cost matrix</li>
                    <li>$\mathbf{b}$ = WWTP maintenance costs</li>
                    <li>$\mathbf{S}$ = Agricultural load reduction coefficients</li>
                    <li>$\mathbf{W} = \mathbf{S} \mathbf{L} \mathbf{F}$ = WWTP effectiveness matrix</li>
                    <li>$B$ = Budget constraint (Million CAD)</li>
                </ul>
            </div>
        </div>
        
        <form method="POST" action="/run-optimization">
            <!-- Model Type Selection -->
            <div class="form-section" style="background-color: rgb(240, 240, 240);">
                <h4 class="text-primary mb-3">Model Type</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="model1" value="target" checked>
                            <label class="form-check-label" for="model1">
                                <strong>Target-Based Model</strong><br>
                                <small class="text-muted">Minimize cost subject to target concentration reductions</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="model2" value="budget">
                            <label class="form-check-label" for="model2">
                                <strong>Budget-Based Model</strong><br>
                                <small class="text-muted">Maximize concentration reduction subject to budget constraint</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Target Model Parameters -->
            <div class="form-section" id="target-params">
                <h4 class="text-primary mb-3">Target Concentration Reductions (ppb)</h4>
                <p class="text-muted mb-3">Specify the target phosphorus concentration reduction for each region in parts per billion (ppb).</p>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="target_scr" class="form-label">SCR (St. Clair River)</label>
                        <input type="number" class="form-control" id="target_scr" name="target_scr" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_lsc" class="form-label">LSC (Lake St. Clair)</label>
                        <input type="number" class="form-control" id="target_lsc" name="target_lsc" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_dr" class="form-label">DR (Detroit River)</label>
                        <input type="number" class="form-control" id="target_dr" name="target_dr" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_wb" class="form-label">WB (Western Basin)</label>
                        <input type="number" class="form-control" id="target_wb" name="target_wb" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_cb" class="form-label">CB (Central Basin)</label>
                        <input type="number" class="form-control" id="target_cb" name="target_cb" value="0.665" step="0.001" min="0">
                        <div class="form-text">Default: 212/318.7 ≈ 0.665</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_eb" class="form-label">EB (Eastern Basin)</label>
                        <input type="number" class="form-control" id="target_eb" name="target_eb" value="0.0" step="0.001" min="0">
                    </div>
                </div>
            </div>

            <!-- Budget Model Parameters -->
            <div class="form-section" id="budget-params" style="display: none;">
                <h4 class="text-primary mb-3">Budget Constraint</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="budget" class="form-label">Budget (Million CAD)</label>
                        <input type="number" class="form-control" id="budget" name="budget" value="500" step="10" min="0">
                        <div class="form-text">Maximum budget available for abatement measures</div>
                    </div>
                </div>
            </div>

            <!-- Advanced Parameters -->
            <div class="form-section">
                <h4 class="text-primary mb-3">Advanced Parameters</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter_efficiency" class="form-label">Filter Efficiency</label>
                        <input type="number" class="form-control" id="filter_efficiency" name="filter_efficiency" value="0.4" step="0.01" min="0" max="1">
                        <div class="form-text">WWTP filter efficiency (0-1)</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="maintenance_cost" class="form-label">Maintenance Cost</label>
                        <input type="number" class="form-control" id="maintenance_cost" name="maintenance_cost" value="0.0001" step="0.00001" min="0">
                        <div class="form-text">Million CAD per (thousand m³ × year)</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_factor" class="form-label">Agriculture Cost Factor</label>
                        <input type="number" class="form-control" id="agro_cost_factor" name="agro_cost_factor" value="0.004" step="0.001" min="0">
                        <div class="form-text">Cost factor for agricultural abatement</div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-play-circle"></i> Run Optimization
                </button>
                <a href="/" class="btn btn-secondary btn-lg ms-3">
                    <i class="bi bi-arrow-left"></i> Back to Home
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const model1Radio = document.getElementById('model1');
    const model2Radio = document.getElementById('model2');
    const targetParams = document.getElementById('target-params');
    const budgetParams = document.getElementById('budget-params');

    function toggleParams() {
        if (model1Radio.checked) {
            targetParams.style.display = 'block';
            budgetParams.style.display = 'none';
        } else {
            targetParams.style.display = 'none';
            budgetParams.style.display = 'block';
        }
    }

    model1Radio.addEventListener('change', toggleParams);
    model2Radio.addEventListener('change', toggleParams);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Optimization Parameters{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h2 class="text-center mb-4">Model Parameters</h2>

        <!-- Mathematical Model Description -->
        <div class="alert alert-info mb-4">
            <h5><i class="bi bi-info-circle"></i> Mathematical Model</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>Target-Based:</h6>
                    <p>
                        $$\min \mathbf{x}^T \mathbf{A} \mathbf{x} + \mathbf{b}^T \mathbf{w}$$
                        subject to:
                        $$\mathbf{S} \mathbf{x} + \mathbf{W} \mathbf{w} \geq \mathbf{z}_{target}$$
                        $$\mathbf{x} \geq 0, \quad \mathbf{w} \in \{0,1\}^{n}$$
                    </p>
                </div>
                <div class="col-md-6">
                    <h6>Budget-Based:</h6>
                    <p>
                        $$\max \mathbf{c}^T (\mathbf{S} \mathbf{x} + \mathbf{W} \mathbf{w})$$
                        subject to:
                        $$\mathbf{x}^T \mathbf{A} \mathbf{x} + \mathbf{b}^T \mathbf{w} \leq B$$
                        $$\mathbf{x} \geq 0, \quad \mathbf{w} \in \{0,1\}^{n}$$
                    </p>
                </div>
            </div>
            <div class="mt-3">
                <h6>Where:</h6>
                <ul class="list-unstyled">
                    <li>$\mathbf{x}$ : Agricultural abatement by region (tonnes/year)</li>
                    <li>$\mathbf{w}$ : Binary variables for WWTP investments (unitless)</li>
                    <li>$\mathbf{A}$ : Agricultural abatement cost matrix (Million CAD/(tonne<sup>2</sup> year))</li>
                    <li>$\mathbf{b}$ : WWTP investment and maintenance costs (Million CAD/(thousand m<sup>3</sup> year))</li>
                    <li>$\mathbf{S}$ : Steady state mass balance matrix (ppb/tonne)</li>
                    <li>$\mathbf{W} = \mathbf{S} \times \mathbf{L} \times \mathbf{F}$ : WWTP effective load matrix (tonne/year)</li>
                    <li>$\mathbf{c}$ : Relative weight vector (unitless)</li>
                    <li>$B$ : Budget constraint (Million CAD)</li>
                    <li>$n$ : Available wastewater treatment plants</li>
                </ul>
            </div>
        </div>
        
        <form method="POST" action="/run-optimization">
            <!-- Model Type Selection -->
            <div class="form-section" style="background-color: rgb(240, 240, 240);">
                <h4 class="text-primary mb-3">Model Type</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="model1" value="target" checked>
                            <label class="form-check-label" for="model1">
                                <strong>Target-Based Model</strong><br>
                                <small class="text-muted">Minimize cost subject to target concentration reductions</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="model2" value="budget">
                            <label class="form-check-label" for="model2">
                                <strong>Budget-Based Model</strong><br>
                                <small class="text-muted">Maximize concentration reduction subject to budget constraint</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Target Model Parameters -->
            <div class="form-section" id="target-params">
                <h4 class="text-primary mb-3">Target P Reductions</h4>
                <p class="text-muted mb-3">Specify the target phosphorus concentration reduction for each region in parts per billion (µg/L).</p>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="target_scr" class="form-label">SCR (St. Clair River)</label>
                        <input type="number" class="form-control" id="target_scr" name="target_scr" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_lsc" class="form-label">LSC (Lake St. Clair)</label>
                        <input type="number" class="form-control" id="target_lsc" name="target_lsc" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_dr" class="form-label">DR (Detroit River)</label>
                        <input type="number" class="form-control" id="target_dr" name="target_dr" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_wb" class="form-label">WB (Western Basin)</label>
                        <input type="number" class="form-control" id="target_wb" name="target_wb" value="0.0" step="0.001" min="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_cb" class="form-label">CB (Central Basin)</label>
                        <input type="number" class="form-control" id="target_cb" name="target_cb" value="0.665" step="0.001" min="0">
                        <div class="form-text">E.g.: 212 tonnes / 318.7 km<sup>3</sup>≈ 0.665 µg/L</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="target_eb" class="form-label">EB (Eastern Basin)</label>
                        <input type="number" class="form-control" id="target_eb" name="target_eb" value="0.0" step="0.001" min="0">
                    </div>
                </div>
            </div>

            <!-- Budget Model Parameters -->
            <div class="form-section" id="budget-params" style="display: none;">
                <h4 class="text-primary mb-3">Budget Constraint</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="budget" class="form-label">Budget (Million CAD)</label>
                        <input type="number" class="form-control" id="budget" name="budget" value="500" step="10" min="0">
                        <div class="form-text">Maximum budget available for abatement measures</div>
                    </div>
                </div>
            </div>

            <!-- Advanced Parameters -->
            <div class="form-section">
                <h4 class="text-primary mb-3">WWTP Parameters</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter_efficiency" class="form-label">WWTP New Technology<br>Efficiency: (0 - 1)</label>
                        <input type="number" class="form-control" id="filter_efficiency" name="filter_efficiency" value="0.4" step="0.01" min="0" max="1">
                        <div class="form-text">Default: 0.4</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="maintenance_cost" class="form-label">Annualized Cost<br>(Invest. + Maintenance)</label>
                        <input type="number" class="form-control" id="maintenance_cost" name="maintenance_cost" value="0.0001" step="0.00001" min="0">
                        <div class="form-text">Million CAD per (thousand m³ × year)</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="wwtp_effluent_threshold" class="form-label">Effluent Threshold<br>(exclude larger plants)</label>
                        <input type="number" class="form-control" id="wwtp_effluent_threshold" name="wwtp_effluent_threshold" value="100000000" step="10" min="0">
                        <div class="form-text">Thousand m³/year<br>(e.g., Kitchener WWTP: 25,000)</div>
                    </div>
                </div>
            </div>

            <!-- Agricultural Cost Parameters -->
            <div class="form-section">
                <h4 class="text-primary mb-3">Agricultural Abatement Costs</h4>
                <p class="text-muted mb-3">Specify the agricultural abatement cost for each region in Million CAD per (tonne² × year).<br>
                Default values assume the same underlying cost function per unit of cropland area.</p>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_scr" class="form-label">SCR (St. Clair River)</label>
                        <input type="number" class="form-control" id="agro_cost_scr" name="agro_cost_scr" value="0.0288" step="0.0001" min="0">
                        <div class="form-text">Default: 0.0288</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_lsc" class="form-label">LSC (Lake St. Clair)</label>
                        <input type="number" class="form-control" id="agro_cost_lsc" name="agro_cost_lsc" value="0.0024" step="0.0001" min="0">
                        <div class="form-text">Default: 0.0024</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_dr" class="form-label">DR (Detroit River)</label>
                        <input type="number" class="form-control" id="agro_cost_dr" name="agro_cost_dr" value="0.062" step="0.0001" min="0">
                        <div class="form-text">Default: 0.062</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_wb" class="form-label">WB (Western Basin)</label>
                        <input type="number" class="form-control" id="agro_cost_wb" name="agro_cost_wb" value="0.0369" step="0.0001" min="0">
                        <div class="form-text">Default: 0.0369</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_cb" class="form-label">CB (Central Basin)</label>
                        <input type="number" class="form-control" id="agro_cost_cb" name="agro_cost_cb" value="0.0089" step="0.0001" min="0">
                        <div class="form-text">Default: 0.0089</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agro_cost_eb" class="form-label">EB (Eastern Basin)</label>
                        <input type="number" class="form-control" id="agro_cost_eb" name="agro_cost_eb" value="0.0031" step="0.0001" min="0">
                        <div class="form-text">Default: 0.0031</div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-play-circle"></i> Run Optimization
                </button>
                <a href="/" class="btn btn-secondary btn-lg ms-3">
                    <i class="bi bi-house"></i> Home
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const model1Radio = document.getElementById('model1');
    const model2Radio = document.getElementById('model2');
    const targetParams = document.getElementById('target-params');
    const budgetParams = document.getElementById('budget-params');

    function toggleParams() {
        if (model1Radio.checked) {
            targetParams.style.display = 'block';
            budgetParams.style.display = 'none';
        } else {
            targetParams.style.display = 'none';
            budgetParams.style.display = 'block';
        }
    }

    model1Radio.addEventListener('change', toggleParams);
    model2Radio.addEventListener('change', toggleParams);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}LEAM - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 text-dark">Lake Erie Abatement Model</h1>
            <br><br>
            <p class="lead">The Lake Erie Abatement Model (LEAM) is a phosphorus abatement optimization model for the Lake Erie watersheds. This tool helps optimize agricultural and wastewater treatment investments to reduce phosphorus concentrations in Lake Erie.</p>
        </div>

        <!-- Lake Erie Regions Map -->
        <div class="card mb-5 col-lg-10 mx-auto">
            <div id="map" style="height: 500px; width: 100%; border: 1px solid #ccc;"></div>
            
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-info-circle"></i> Overview
                        </h5>
                        <p class="card-text">
                            The Target-Based Model minimizes the cost of achieving a user-defined phosphorus abatement target across six Lake Erie regions. The Budget-Based Model maximizes phosphorus abatement given a fixed monetary budget.
                        </p>
                        <ul class="list-unstyled">
                            <li><strong>Decision Variables:</strong></li>
                            <li>• Agricultural abatement on each region</li>
                            <li>• Investment on WWTP upgrades across regions</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-geo-alt"></i> Lake Erie Watershed Regions
                        </h5>
                        <p class="card-text">
                            The model covers six regions of Lake Erie:
                        </p>
                        <ul class="list-unstyled">
                            <li>• St. Clair River (SCR)</li>
                            <li>• Lake St. Clair (LSC)</li>
                            <li>• Detroit River (DR)</li>
                            <li>• Lake Erie Western Basin (WB)</li>
                            <li>• Lake Erie Central Basin (CB)</li>
                            <li>• Lake Erie Eastern Basin (EB)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/optimize" class="btn btn-primary btn-lg">
                <i class="bi bi-calculator"></i> Start Optimization
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize the map
    const map = L.map('map').setView([42.5, -81.5], 7);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Define color palette for regions
    const regionColors = {
        'SCR': 'crimson',
        'LSC': 'deepskyblue',
        'DR': 'lime',
        'WB': 'orange',
        'CB': 'deeppink',
        'EB': 'indigo'
    };

    // Function to get color based on region
    function getRegionColor(region) {
        return regionColors[region] || '#999999';
    }

    // Function to style watersheds
    function watershedStyle(feature) {
        return {
            fillColor: getRegionColor(feature.properties.REGION),
            weight: 0.3,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.6
        };
    }

    // Function to highlight feature on hover
    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({
            weight: 3,
            color: '#666',
            fillOpacity: 0.8
        });
        layer.bringToFront();
    }

    // Function to reset highlight
    function resetHighlight(e) {
        watershedsLayer.resetStyle(e.target);
    }

    // Function to add popup on click
    function onEachWatershed(feature, layer) {
        const region = feature.properties.REGION || 'Unknown';
        const code = feature.properties.CODE || 'N/A';
        
        layer.bindPopup(`
            <strong>Region:</strong> ${region}<br>
            <strong>Code:</strong> ${code}
        `);
        
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight
        });
    }

    // Create layer variables
    let basinLayer, watershedsLayer;

    // Load Lake Erie basin boundary
    fetch('/static/geojson/le_basin.geojson')
        .then(response => response.json())
        .then(data => {
            basinLayer = L.geoJSON(data, {
                style: {
                    fillColor: 'lightblue',
                    weight: 3,
                    opacity: 1,
                    color: '#003366',
                    fillOpacity: 0.2
                }
            }).addTo(map);
            
            // Fit map to basin bounds
            map.fitBounds(basinLayer.getBounds());
        })
        .catch(error => console.error('Error loading basin:', error));

    // Load watersheds
    fetch('/static/geojson/watersheds.geojson')
        .then(response => response.json())
        .then(data => {
            watershedsLayer = L.geoJSON(data, {
                style: watershedStyle,
                onEachFeature: onEachWatershed
            }).addTo(map);
        })
        .catch(error => console.error('Error loading watersheds:', error));

    // Add legend
    const legend = L.control({position: 'bottomright'});
    
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.border = '2px solid rgba(0,0,0,0.2)';
        div.style.borderRadius = '5px';
        
        const regions = [
            {code: 'SCR', name: 'St. Clair River'},
            {code: 'LSC', name: 'Lake St. Clair'},
            {code: 'DR', name: 'Detroit River'},
            {code: 'WB', name: 'Western Basin'},
            {code: 'CB', name: 'Central Basin'},
            {code: 'EB', name: 'Eastern Basin'}
        ];
        
        div.innerHTML = '<strong>Regions</strong><br>';
        
        regions.forEach(region => {
            div.innerHTML += 
                '<i style="background:' + getRegionColor(region.code) + 
                '; width: 18px; height: 18px; display: inline-block; margin-right: 5px; opacity: 0.6;"></i> ' +
                region.code + ' - ' + region.name + '<br>';
        });
        
        return div;
    };
    
    legend.addTo(map);
</script>
{% endblock %}